notifications:
  email: false

dist: jessie
sudo: required

matrix:
  fast_finish: true

services:
  - postgresql
  - redis-server
  - docker

addons:
  postgresql: '9.5'

language: php
php: '7.0'

before_install:
  - sudo apt-get update -qq
  # Remove error could not access file "$libdir/postgis-2.3": No such file or directory
  - sudo apt-get install -y $(apt-cache search postgis | awk '/^postgresql-9\.[2-6]-postgis-2.3/{printf " "$1}' )

before_script:
  # Configure JSON Web Token
  - mkdir -p var/jwt
  - openssl genrsa -out var/jwt/private.pem 4096
  - openssl rsa -pubout -in var/jwt/private.pem -out var/jwt/public.pem
  # Configure PostgreSQL
  - psql -U postgres -c 'create database coursiers;'
  - psql -U postgres -c 'create extension postgis;'
  # Install OSRM
  - mkdir -p var/osrm
  - wget https://s3.amazonaws.com/metro-extracts.mapzen.com/paris_france.osm.pbf -P var/osrm
  - docker run -t -v $(pwd)/var/osrm:/data osrm/osrm-backend:v5.5.4 osrm-extract -p /opt/bicycle.lua /data/paris_france.osm.pbf
  - docker run -t -v $(pwd)/var/osrm:/data osrm/osrm-backend:v5.5.4 osrm-contract /data/paris_france.osrm
  - docker run -t -v $(pwd)/var/osrm:/data -d -p 5000:5000 osrm/osrm-backend:v5.5.4 osrm-routed /data/paris_france.osrm
  # Install PHP app
  - composer self-update
  - composer install --dev --prefer-dist
script:
  - curl 'http://localhost:5000/route/v1/bicycle/2.3706188,48.877821;2.385706,48.887031?overview=full'
  - cp phpunit.xml.dist phpunit.xml
  - phpunit
